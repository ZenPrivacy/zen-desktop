version: '3'

vars:
  ARCH64: '{{if eq ARCH "arm"}}arm64{{else}}{{ARCH}}{{end}}'
  NSIS_ARCH_FLAG: '{{if or (eq ARCH "arm64") (eq ARCH "arm")}}ARM64{{else}}AMD64{{end}}'
  GIT_TAG:
    sh: git describe --tags --always --abbrev=0
  INSTANCE_ID:
    sh: node -e 'const {randomUUID}=require("node:crypto");console.log(randomUUID());'

tasks:
  prod:
    desc: Create a production build of the application.
    env:
      CANARY_MAKENSIS_ROOT_DIR: '{{.ROOT_DIR}}'
      CANARY_MAKENSIS_ARCH: '{{.NSIS_ARCH_FLAG}}'
    cmds:
      - powershell -NoProfile -ExecutionPolicy Bypass -File "{{.ROOT_DIR}}/build/windows/setup-canary-makensis.ps1" install "{{.ROOT_DIR}}/build/windows/canary-makensis.ps1"
      - wails build -o Zen.exe -platform "windows/{{default .ARCH64 .ARCH}}" -nsis -ldflags "-X 'github.com/ZenPrivacy/zen-desktop/internal/cfg.Version={{.GIT_TAG}}' -X 'github.com/ZenPrivacy/zen-desktop/internal/constants.InstanceID={{.INSTANCE_ID}}'" -m -skipbindings -tags prod
      - powershell -NoProfile -ExecutionPolicy Bypass -File "{{.ROOT_DIR}}/build/windows/setup-canary-makensis.ps1" uninstall

  nsis:
    desc: Build the NSIS installer using the existing binary in build/bin.
    dir: '{{.ROOT_DIR}}/build/windows/installer'
    cmds:
      - makensis -DARG_WAILS_{{.NSIS_ARCH_FLAG}}_BINARY={{.ROOT_DIR}}/build/bin/Zen.exe project.nsi

  prod-noupdate:
    desc: Create a production build of the application with self-updates disabled. Doesn't build an installer.
    cmds:
      - wails build -o Zen.exe -platform "windows/{{default .ARCH64 .ARCH}}" -ldflags "-X 'github.com/ZenPrivacy/zen-desktop/internal/cfg.Version={{.GIT_TAG}}' -X 'github.com/ZenPrivacy/zen-desktop/internal/constants.InstanceID={{.INSTANCE_ID}}' -X 'github.com/ZenPrivacy/zen-desktop/internal/selfupdate.NoSelfUpdate=true'" -m -skipbindings -tags prod
